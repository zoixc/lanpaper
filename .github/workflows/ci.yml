name: CI/CD
on:
  push:
    branches: [ improvements ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - uses: actions/setup-go@v5
      with:
        go-version: '1.25'
    - run: go mod tidy
    - run: go vet ./...
    - run: go test -v ./...
    - run: go build ./...

  docker:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - uses: docker/setup-qemu-action@v3
    - uses: docker/setup-buildx-action@v3
    - name: Determine version
      id: version
      run: |
        VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "dev")
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
    - name: Build & Test local
      run: |
        docker buildx build --platform linux/amd64 \
          --build-arg VERSION=${{ steps.version.outputs.VERSION }} \
          -t lanpaper:test --load .
        docker run --rm lanpaper:test /health
    - name: Login & Push to GHCR
      if: github.ref == 'refs/heads/improvements'
      run: |
        echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        VERSION=${{ steps.version.outputs.VERSION }}
        docker buildx build \
          --build-arg VERSION=$VERSION \
          --platform linux/amd64,linux/arm64 \
          -t ghcr.io/zoixc/lanpaper:$VERSION \
          -t ghcr.io/zoixc/lanpaper:latest \
          --push .
